# 二次压降检测仪信息管理系统

## 课程设计报告

---

**学生姓名：** [请填写]  
**学号：** [请填写]  
**专业班级：** [请填写]  
**指导教师：** [请填写]  
**完成日期：** 2026年1月3日

---

## 目录

第1章 项目概述与需求分析 ................................................ 1  
　1.1 项目背景 ................................................ 1  
　1.2 项目目标 ................................................ 1  
　1.3 功能需求分析 ................................................ 2  
　　1.3.1 数据输入管理需求 ................................................ 2  
　　1.3.2 数据管理需求 ................................................ 2  
　　1.3.3 查询统计需求 ................................................ 2  
　　1.3.4 报告生成需求 ................................................ 3  
　1.4 非功能需求分析 ................................................ 3  

第2章 系统分析与设计 ................................................ 4  
　2.1 系统架构设计 ................................................ 4  
　　2.1.1 总体架构 ................................................ 4  
　　2.1.2 技术架构 ................................................ 5  
　2.2 技术选型 ................................................ 5  
　　2.2.1 开发框架选择 ................................................ 5  
　　2.2.2 数据库选择 ................................................ 6  
　2.3 数据库设计 ................................................ 6  
　　2.3.1 数据库E-R图 ................................................ 6  
　　2.3.2 数据表设计 ................................................ 7  
　2.4 类设计 ................................................ 10  
　　2.4.1 核心类图 ................................................ 10  
　　2.4.2 类职责说明 ................................................ 11  

第3章 核心功能实现 ................................................ 12  
　3.1 数据输入模块 ................................................ 12  
　　3.1.1 手动输入功能 ................................................ 12  
　　3.1.2 批量导入功能 ................................................ 14  
　3.2 数据管理模块 ................................................ 16  
　　3.2.1 数据库连接管理 ................................................ 16  
　　3.2.2 数据CRUD操作 ................................................ 17  
　　3.2.3 数据展示 ................................................ 19  
　3.3 查询统计模块 ................................................ 20  
　　3.3.1 时间段统计 ................................................ 20  
　　3.3.2 厂商合格率统计 ................................................ 21  
　　3.3.3 月度工作量统计 ................................................ 22  
　3.4 报告生成模块 ................................................ 23  
　　3.4.1 报告内容设计 ................................................ 23  
　　3.4.2 PDF生成实现 ................................................ 24  
　　3.4.3 打印功能实现 ................................................ 26  

第4章 系统测试 ................................................ 27  
　4.1 测试环境 ................................................ 27  
　4.2 功能测试 ................................................ 27  
　　4.2.1 数据输入测试 ................................................ 27  
　　4.2.2 数据管理测试 ................................................ 28  
　　4.2.3 查询统计测试 ................................................ 29  
　　4.2.4 报告生成测试 ................................................ 30  
　4.3 界面展示 ................................................ 31  
　4.4 测试结果分析 ................................................ 32  

第5章 总结 ................................................ 33  
　5.1 项目完成情况 ................................................ 33  
　5.2 技术亮点 ................................................ 33  
　5.3 存在的问题 ................................................ 34  
　5.4 改进方向 ................................................ 34  
　5.5 个人体会 ................................................ 35  

参考文献 ................................................ 36

---

<div style="page-break-after: always;"></div>





# 第1章 项目概述与需求分析



## 1.1 项目背景

随着电力系统的不断发展和完善，互感器二次压降检测仪作为重要的计量检测设备，其检定工作量日益增加。传统的纸质记录和人工统计方式存在效率低下、数据易丢失、查询不便、统计困难等问题。为了提高检定工作的效率和质量，规范检定数据的管理，实现检定报告的自动化生成，开发一套专业的二次压降检测仪信息管理系统具有重要的现实意义。

本系统旨在通过信息化手段，实现检定数据的电子化存储、规范化管理和智能化分析，为检定工作提供全面的信息化支持。



## 1.2 项目目标

本项目的主要目标是开发一套功能完善、操作便捷的二次压降检测仪信息管理系统，具体目标包括：

（1）实现检定数据的规范化录入和批量导入，提高数据录入效率。

（2）建立完整的数据库管理系统，确保数据的安全性和完整性。

（3）提供灵活的查询统计功能，支持多维度的数据分析。

（4）实现检定报告的自动化生成，支持PDF导出和打印功能。

（5）提供友好的用户界面，降低用户学习成本，提高工作效率。



## 1.3 功能需求分析



### 1.3.1 数据输入管理需求

系统需要支持两种数据输入方式：

（1）手动输入：提供友好的数据录入界面，支持逐条添加厂商信息、设备信息、检测记录和检测结果数据。录入界面需要包含必要的数据验证功能，确保数据的准确性和完整性。对于具有关联关系的数据（如设备与厂商的关联），需要提供下拉选择框，方便用户快速选择。

（2）批量导入：支持CSV/Excel格式文件的批量导入功能，适用于大量历史数据的迁移或批量录入场景。导入过程需要显示进度条，并在导入完成后给出详细的统计信息（成功数量、失败数量、失败原因等）。



### 1.3.2 数据管理需求

系统需要将所有实验数据统一存储在数据库中，支持完整的数据管理功能：

（1）数据查询：支持按不同维度查询数据，包括按厂商查询、按设备查询、按时间范围查询等。查询结果以表格形式展示，支持排序和筛选。

（2）数据修改：支持对已录入数据的修改功能，修改时需要保持数据的完整性约束。

（3）数据删除：支持数据的删除功能，删除时需要考虑关联数据的处理（级联删除或拒绝删除）。

（4）数据展示：提供清晰的数据展示界面，支持在不同数据表之间快速切换。



### 1.3.3 查询统计需求

系统需要提供丰富的查询统计功能，支持多维度的数据分析：

（1）时间段统计：支持按时间段（开始日期到结束日期）统计检测数量，了解不同时期的工作量分布。

（2）厂商统计：支持按厂商统计检测数量和合格率，分析不同厂商设备的质量水平。

（3）月度统计：支持按月统计检测工作量，便于工作量的月度汇总和分析。

（4）联表查询：支持跨表的联合查询，例如查询某个厂商的所有设备及其检测记录。

统计结果需要以直观的方式展示，包括表格和汇总信息，必要时可提供图表展示。



### 1.3.4 报告生成需求

系统需要根据实验结果自动生成规范的检测报告：

（1）报告内容：报告应包含完整的检测信息，包括设备基本信息、检测条件、检测结果项（PT1、PT2、CT1、CT2）、详细测量数据（ao、bo、co点的测量值）、检测结论等。

（2）报告格式：报告格式需符合行业规范，布局合理、信息完整、易于阅读。

（3）PDF导出：支持将报告导出为PDF格式，便于存档和分发。

（4）打印功能：支持直接打印报告，提供打印预览功能。



## 1.4 非功能需求分析

（1）性能需求：系统应具有良好的响应速度，数据查询和统计操作应在1秒内完成。支持至少10000条检测记录的存储和查询。

（2）可靠性需求：系统应具有较高的稳定性，避免因程序错误导致数据丢失。数据库操作需要有适当的错误处理机制。

（3）易用性需求：系统界面应简洁友好，操作流程符合用户习惯。关键操作需要有明确的提示信息。

（4）可维护性需求：代码结构应清晰，模块划分合理，便于后期维护和功能扩展。

（5）兼容性需求：系统应能在Windows 10及以上操作系统上稳定运行。


<div style="page-break-after: always;"></div>





# 第2章 系统分析与设计



## 2.1 系统架构设计



### 2.1.1 总体架构

本系统采用经典的三层架构设计模式，将系统划分为表示层、业务逻辑层和数据访问层，实现了界面展示、业务处理和数据存储的分离，提高了系统的可维护性和可扩展性。

（1）表示层（Presentation Layer）

表示层负责与用户交互，包括主窗口（MainWindow）、各类对话框（AddDialog、StatisticsDialog、DetailDataDialog）等界面组件。该层使用Qt Widgets框架实现，提供友好的图形用户界面。

（2）业务逻辑层（Business Logic Layer）

业务逻辑层包含系统的核心业务处理逻辑，主要包括：
- CSVImporter：负责CSV文件的解析和批量导入
- ReportGenerator：负责检测报告的生成和PDF导出
- 数据验证和业务规则处理

（3）数据访问层（Data Access Layer）

数据访问层负责与数据库的交互，主要由DatabaseHelper类实现。该类采用单例模式设计，提供统一的数据库访问接口，封装了所有的SQL操作。

三层之间的调用关系如下：

```
表示层 → 业务逻辑层 → 数据访问层 → SQLite数据库
```



### 2.1.2 技术架构

系统的技术架构包括以下几个层次：

（1）应用框架层：使用Qt 6.8.3框架，提供跨平台的GUI支持、信号槽机制、事件处理等基础功能。

（2）数据库层：使用SQLite嵌入式数据库，通过Qt SQL模块进行访问。

（3）文档处理层：使用QPdfWriter和QPainter实现PDF报告的生成。

（4）数据交换层：使用Qt的CSV解析功能实现批量数据导入。



## 2.2 技术选型



### 2.2.1 开发框架选择

本系统选择Qt 6.8.3作为开发框架，主要基于以下考虑：

（1）跨平台特性：Qt是一个跨平台的C++图形用户界面应用程序开发框架，可以在Windows、Linux、macOS等多个平台上运行，具有良好的可移植性。

（2）丰富的组件库：Qt提供了丰富的GUI组件，如QTableView、QDialog、QMenu等，能够快速构建专业的用户界面。

（3）完善的数据库支持：Qt SQL模块提供了对多种数据库的支持，包括SQLite、MySQL、PostgreSQL等，使用QSqlTableModel和QSqlQuery可以方便地进行数据库操作。

（4）信号槽机制：Qt的信号槽机制提供了一种类型安全的事件通信方式，使得对象之间的通信更加简洁和灵活。

（5）文档处理能力：Qt提供了QPdfWriter、QPrinter等类，可以方便地生成PDF文档和实现打印功能。

（6）活跃的社区支持：Qt拥有庞大的开发者社区和丰富的学习资源，便于问题解决和技术交流。



### 2.2.2 数据库选择

本系统选择SQLite作为数据库管理系统，主要原因如下：

（1）轻量级：SQLite是一个嵌入式数据库，不需要独立的数据库服务器进程，数据库存储在单个文件中，便于部署和管理。

（2）零配置：SQLite不需要安装和配置，开箱即用，降低了系统部署的复杂度。

（3）可靠性：SQLite实现了ACID（原子性、一致性、隔离性、持久性）特性，保证了数据的可靠性。

（4）完整的SQL支持：SQLite支持标准SQL语法，包括复杂查询、聚合函数、联表查询等，能够满足系统的统计分析需求。

（5）与Qt的良好集成：Qt SQL模块对SQLite提供了原生支持，通过QSQLITE驱动可以直接访问SQLite数据库。

（6）适合中小规模应用：对于本系统的数据规模（预计万条级别的记录），SQLite能够提供良好的性能表现。



## 2.3 数据库设计



### 2.3.1 数据库E-R图

系统的实体关系图如图2-1所示，包含四个核心实体及其关联关系。

图2-1 系统E-R图

```
                    ┌──────────────┐
                    │ manufacturers│
                    │   (厂商)     │
                    └──────┬───────┘
                           │ 1
                           │
                           │ n
                    ┌──────┴───────┐
                    │equipment_info│
                    │   (设备)     │
                    └──────┬───────┘
                           │ 1
                           │
                           │ n
                    ┌──────┴───────┐
                    │ test_records │
                    │  (检测记录)  │
                    └──────┬───────┘
                           │ 1
                           │
                       ┌───┴────┬──────────────────┐
                       │ n      │ n                │ n
              ┌────────┴──┐ ┌───┴────────────┐ ┌──┴────────────┐
              │test_result│ │test_result     │ │test_result    │
              │_items     │ │_details        │ │_...           │
              │(检测结果) │ │(详细数据)      │ │(扩展表)       │
              └───────────┘ └────────────────┘ └───────────────┘
```

实体关系说明：

（1）一个厂商可以生产多台设备（1:n关系）
（2）一台设备可以有多次检测记录（1:n关系）
（3）一次检测记录包含多个检测结果项（1:n关系）
（4）一次检测记录包含一组详细测量数据（1:n关系）



### 2.3.2 数据表设计

系统共设计了5张数据表，各表的详细结构如下：

**表2-1 manufacturers（厂商信息表）**

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，自增 |
| name | TEXT | NOT NULL UNIQUE | 厂商名称，唯一 |
| contact_person | TEXT | - | 联系人 |
| phone | TEXT | - | 联系电话 |
| address | TEXT | - | 厂商地址 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**表2-2 equipment_info（设备信息表）**

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，自增 |
| product_code | TEXT | NOT NULL | 产品编号 |
| product_name | TEXT | NOT NULL | 产品名称 |
| manufacturer_id | INTEGER | FOREIGN KEY | 外键，关联厂商表 |
| production_date | DATE | - | 生产日期 |
| product_location | TEXT | - | 产地 |
| product_model | TEXT | - | 产品型号 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**表2-3 test_records（检测记录表）**

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，自增 |
| equipment_id | INTEGER | NOT NULL, FOREIGN KEY | 外键，关联设备表 |
| test_date | DATE | NOT NULL | 检测日期 |
| tester_name | TEXT | NOT NULL | 检测员姓名 |
| test_location | TEXT | NOT NULL | 检测地点 |
| secondary_voltage | REAL | - | 二次电压 |
| temperature | REAL | - | 环境温度 |
| humidity | REAL | - | 环境湿度 |
| metering_point_code | TEXT | - | 计量点编号 |
| test_date_code | TEXT | - | 测试日期编号 |
| remarks | TEXT | - | 备注信息 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**表2-4 test_result_items（检测结果项表）**

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，自增 |
| test_record_id | INTEGER | NOT NULL, FOREIGN KEY | 外键，关联检测记录 |
| item_name | TEXT | NOT NULL | 项目名称（PT1/PT2/CT1/CT2） |
| gear_position | TEXT | - | 档位（如100V、5A） |
| percentage | REAL | - | 百分比（如20%、100%） |
| data_lower_limit | REAL | - | 数据下限 |
| data_upper_limit | REAL | - | 数据上限 |
| measured_data | REAL | - | 实测数据 |
| is_qualified | BOOLEAN | - | 是否合格 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

说明：每次检测记录通常包含4个检测结果项（PT1、PT2、CT1、CT2），每个项目包含多个不同档位和百分比的测量点。

**表2-5 test_result_details（详细测量数据表）**

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 主键，自增 |
| test_record_id | INTEGER | NOT NULL, FOREIGN KEY | 外键，关联检测记录 |
| item_name | TEXT | NOT NULL | 项目名称（PT侧/CT侧） |
| ao_f | REAL | - | ao点 f(%) |
| ao_d | REAL | - | ao点 d(分) |
| ao_du | REAL | - | ao点 dU(%) |
| ao_upt | REAL | - | ao点 Upt:U |
| ao_uyb | REAL | - | ao点 Uyb:U |
| bo_f | REAL | - | bo点 f(%) |
| bo_d | REAL | - | bo点 d(分) |
| bo_du | REAL | - | bo点 dU(%) |
| bo_upt | REAL | - | bo点 Upt:U |
| bo_uyb | REAL | - | bo点 Uyb:U |
| co_f | REAL | - | co点 f(%) |
| co_d | REAL | - | co点 d(分) |
| co_du | REAL | - | co点 dU(%) |
| co_upt | REAL | - | co点 Upt:U |
| co_uyb | REAL | - | co点 Uyb:U |
| pt_check_note | TEXT | - | PT侧备注 |
| r_percentage | REAL | - | r%值 |
| measurement_result | TEXT | - | 测量结束值 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

说明：该表存储每次检测的详细测量数据，包括ao、bo、co三个测量点的完整数据。



## 2.4 类设计



### 2.4.1 核心类图

系统的核心类及其关系如图2-2所示。

图2-2 系统核心类图

```
┌─────────────────┐
│  MainWindow     │
│  (主窗口)       │
├─────────────────┤
│ - m_tableView   │
│ - m_currentModel│
│ - m_currentTable│
├─────────────────┤
│ + onAddRecord() │
│ + onDeleteRecord()│
│ + onImportCSV() │
│ + onStatistics()│
│ + onExportPDF() │
└────────┬────────┘
         │ uses
         ├──────────┐
         │          │
         ▼          ▼
┌────────────┐  ┌──────────────┐
│AddDialog   │  │StatisticsDialog│
│(添加对话框)│  │(统计对话框)   │
└────────────┘  └──────────────┘

┌─────────────────┐
│ DatabaseHelper  │
│ (数据库管理)    │
├─────────────────┤
│ - m_database    │
│ - m_instance    │
├─────────────────┤
│ + instance()    │
│ + initDatabase()│
│ + getDatabase() │
│ + createTables()│
└────────┬────────┘
         │
         │ uses
         ▼
┌─────────────────┐
│  CSVImporter    │
│ (CSV导入器)     │
├─────────────────┤
│ + importCSV()   │
│ + parseCSV()    │
└─────────────────┘

┌─────────────────┐
│ ReportGenerator │
│ (报告生成器)    │
├─────────────────┤
│ + generatePDF() │
│ + printReport() │
└─────────────────┘
```



### 2.4.2 类职责说明

（1）**MainWindow类**

职责：系统主窗口，负责界面布局、菜单栏、工具栏的创建，以及各功能模块的调度。

主要方法：
- setupUI()：初始化用户界面
- setupMenuBar()：创建菜单栏
- setupToolBar()：创建工具栏
- loadTableData()：加载并展示数据表
- onShowManufacturers/Equipment/TestRecords/TestItems()：切换不同数据视图
- onAddRecord()：添加新记录
- onDeleteRecord()：删除选中记录
- onRefreshData()：刷新数据
- onImportCSV()：导入CSV文件
- onStatistics()：打开统计对话框
- onExportPDF()：导出PDF报告
- onPrintReport()：打印报告

（2）**DatabaseHelper类**

职责：数据库管理类，采用单例模式，负责数据库的初始化、表的创建和数据库连接的管理。

主要方法：
- instance()：获取单例实例
- initDatabase()：初始化数据库连接
- getDatabase()：获取数据库对象
- createTables()：创建数据库表
- insertTestDetailsData()：插入测试数据
- clearAllData()：清空所有数据

（3）**AddDialog类**

职责：数据添加对话框，提供统一的数据录入界面，支持厂商、设备、检测记录、检测结果的添加。

主要方法：
- setupUI()：根据表类型创建相应的输入控件
- onAccept()：验证并保存数据
- loadRelatedData()：加载关联数据（如厂商列表、设备列表）

（4）**CSVImporter类**

职责：CSV文件导入器，负责解析CSV文件并将数据批量导入数据库。

主要方法：
- importManufacturers()：导入厂商数据
- importEquipment()：导入设备数据
- importTestRecords()：导入检测记录
- importTestItems()：导入检测结果项
- parseCSVLine()：解析CSV行数据

（5）**StatisticsDialog类**

职责：统计分析对话框，提供多维度的数据统计功能。

主要方法：
- setupUI()：创建统计界面
- onTimeRangeStatistics()：按时间段统计
- onManufacturerStatistics()：按厂商统计
- onMonthlyStatistics()：按月统计

（6）**ReportGenerator类**

职责：报告生成器，负责生成检测报告并导出为PDF格式。

主要方法：
- generateReport()：生成HTML格式报告
- exportToPDF()：将报告导出为PDF
- printReport()：打印报告
- drawReportContent()：绘制报告内容

（7）**DetailDataDialog类**

职责：详细数据对话框，用于查看和编辑检测记录的详细测量数据（ao、bo、co点数据）。

主要方法：
- loadDetailData()：加载详细数据
- saveDetailData()：保存详细数据修改


<div style="page-break-after: always;"></div>





# 第3章 核心功能实现



## 3.1 数据输入模块



### 3.1.1 手动输入功能

手动输入功能通过AddDialog类实现，该类提供了一个通用的数据录入对话框，支持不同类型数据的添加。

**（1）设计思路**

AddDialog采用枚举类型（DialogType）区分不同的对话框类型，根据不同类型动态创建相应的输入控件。主要类型包括：
- AddManufacturer：添加厂商信息
- AddEquipment：添加设备信息
- AddTestRecord：添加检测记录
- AddTestItem：添加检测结果项

**（2）界面创建实现**

以设备信息添加为例，界面创建代码如下：

```cpp
void AddDialog::setupEquipmentUI()
{
    QVBoxLayout *layout = new QVBoxLayout(this);
    QFormLayout *formLayout = new QFormLayout();
    
    // 创建输入控件
    m_productCode = new QLineEdit(this);
    m_productName = new QLineEdit(this);
    m_manufacturerCombo = new QComboBox(this);
    m_productionDate = new QDateEdit(QDate::currentDate(), this);
    m_productionDate->setCalendarPopup(true);
    
    // 加载厂商列表（联表查询）
    QSqlQuery query(DatabaseHelper::instance()->getDatabase());
    query.exec("SELECT id, name FROM manufacturers ORDER BY name");
    while (query.next()) {
        m_manufacturerCombo->addItem(query.value(1).toString(), 
                                     query.value(0));
    }
    
    formLayout->addRow("产品编号*:", m_productCode);
    formLayout->addRow("产品名称*:", m_productName);
    formLayout->addRow("厂商:", m_manufacturerCombo);
    formLayout->addRow("生产日期:", m_productionDate);
}
```

**（3）数据验证与保存**

系统提供完善的数据验证机制，确保数据的准确性和完整性：

```cpp
void AddDialog::accept()
{
    if (m_type == AddEquipment) {
        if (m_productCode->text().trimmed().isEmpty() || 
            m_productName->text().trimmed().isEmpty()) {
            QMessageBox::warning(this, "输入错误", 
                               "产品编号和产品名称不能为空！");
            return;
        }
        
        QSqlQuery query(DatabaseHelper::instance()->getDatabase());
        query.prepare("INSERT INTO equipment_info "
                      "(product_code, product_name, manufacturer_id, "
                      "production_date, product_location, product_model) "
                      "VALUES (?, ?, ?, ?, ?, ?)");
        query.addBindValue(m_productCode->text().trimmed());
        query.addBindValue(m_productName->text().trimmed());
        query.addBindValue(m_manufacturerCombo->currentData());
        query.addBindValue(m_productionDate->date().toString("yyyy-MM-dd"));
        query.addBindValue(m_productLocation->text().trimmed());
        query.addBindValue(m_productModel->text().trimmed());
        
        if (!query.exec()) {
            QMessageBox::critical(this, "错误", 
                                "添加失败：" + query.lastError().text());
            return;
        }
    }
    QDialog::accept();
}
```

**（4）功能特点**

- 使用QFormLayout实现表单布局，界面整洁
- 带*号标识必填字段
- 使用QComboBox实现关联数据的下拉选择
- 使用QDateEdit提供日历选择功能
- 完善的数据验证和错误提示



### 3.1.2 批量导入功能

批量导入功能通过CSVImporter类实现，支持从CSV文件批量导入数据。

**（1）CSV文件解析**

实现了专门的CSV行解析函数，正确处理逗号和引号：

```cpp
QStringList CSVImporter::parseLine(const QString &line)
{
    QStringList result;
    QString field;
    bool inQuotes = false;
    
    for (int i = 0; i < line.length(); ++i) {
        QChar c = line[i];
        if (c == '"') {
            inQuotes = !inQuotes;
        } else if (c == ',' && !inQuotes) {
            result << field.trimmed();
            field.clear();
        } else {
            field += c;
        }
    }
    result << field.trimmed();
    return result;
}
```

**（2）批量导入实现**

```cpp
bool CSVImporter::importEquipment(const QString &filePath)
{
    QFile file(filePath);
    if (!file.open(QIODevice::ReadOnly | QIODevice::Text)) {
        emit finished(false, "无法打开文件");
        return false;
    }
    
    QTextStream in(&file);
    in.setEncoding(QStringConverter::Utf8);
    if (!in.atEnd()) in.readLine();  // 跳过表头
    
    int count = 0;
    QSqlQuery query(DatabaseHelper::instance()->getDatabase());
    
    while (!in.atEnd()) {
        QString lineText = in.readLine();
        if (lineText.trimmed().isEmpty()) continue;
        
        QStringList fields = parseLine(lineText);
        if (fields.size() < 6) continue;
        
        query.prepare("INSERT INTO equipment_info "
                      "(product_code, product_name, manufacturer_id, "
                      "production_date, product_location, product_model) "
                      "VALUES (?, ?, ?, ?, ?, ?)");
        query.addBindValue(fields[0]);
        query.addBindValue(fields[1]);
        query.addBindValue(fields[2].isEmpty() ? QVariant() : 
                          fields[2].toInt());
        query.addBindValue(fields[3]);
        query.addBindValue(fields[4]);
        query.addBindValue(fields[5]);
        
        if (query.exec()) {
            count++;
            emit progress(count, QString("已导入%1条记录").arg(count));
        }
    }
    
    file.close();
    emit finished(true, QString("成功导入%1条记录").arg(count));
    return true;
}
```

**（3）功能特点**

- 支持UTF-8编码
- 智能解析CSV格式
- 使用参数化查询防止SQL注入
- 实时进度显示
- 详细的错误提示



## 3.2 数据管理模块



### 3.2.1 数据库连接管理

DatabaseHelper类采用单例模式设计，确保只有一个数据库连接实例：

```cpp
DatabaseHelper* DatabaseHelper::instance()
{
    if (!m_instance) {
        m_instance = new DatabaseHelper();
    }
    return m_instance;
}

bool DatabaseHelper::initDatabase()
{
    m_database = QSqlDatabase::addDatabase("QSQLITE");
    m_database.setDatabaseName("ecyj_database.db");
    
    if (!m_database.open()) {
        qDebug() << "数据库打开失败:" << m_database.lastError().text();
        return false;
    }
    
    createTables();
    return true;
}
```



### 3.2.2 数据CRUD操作

**（1）数据查询与展示**

使用QSqlTableModel将数据库表绑定到QTableView：

```cpp
void MainWindow::loadTableData(const QString &tableName)
{
    if (m_currentModel) delete m_currentModel;
    
    m_currentTable = tableName;
    
    if (tableName == "equipment_info") {
        QSqlRelationalTableModel *model = new QSqlRelationalTableModel(this,
            DatabaseHelper::instance()->getDatabase());
        model->setTable(tableName);
        model->setRelation(3, QSqlRelation("manufacturers", "id", "name"));
        m_currentModel = model;
    } else {
        m_currentModel = new QSqlTableModel(this,
            DatabaseHelper::instance()->getDatabase());
        m_currentModel->setTable(tableName);
    }
    
    m_currentModel->setEditStrategy(QSqlTableModel::OnManualSubmit);
    m_currentModel->select();
    
    // 设置中文表头
    m_currentModel->setHeaderData(1, Qt::Horizontal, "厂商名称");
    // ...
    
    m_tableView->setModel(m_currentModel);
    m_tableView->hideColumn(0);
}
```

**（2）数据删除**

支持批量删除和级联删除：

```cpp
void MainWindow::onDeleteRecord()
{
    QModelIndexList selected = m_tableView->selectionModel()->selectedRows();
    if (selected.isEmpty()) {
        QMessageBox::warning(this, "提示", "请先选择要删除的记录");
        return;
    }
    
    int ret = QMessageBox::question(this, "确认删除",
                                     QString("确定要删除选中的%1条记录吗？")
                                     .arg(selected.count()));
    if (ret == QMessageBox::No) return;
    
    for (int i = selected.count() - 1; i >= 0; --i) {
        m_currentModel->removeRow(selected.at(i).row());
    }
    
    if (m_currentModel->submitAll()) {
        QMessageBox::information(this, "成功", "删除成功！");
        m_currentModel->select();
    } else {
        QMessageBox::critical(this, "错误", 
                             "删除失败：" + m_currentModel->lastError().text());
        m_currentModel->revertAll();
    }
}
```



### 3.2.3 数据展示界面

系统提供了友好的数据展示界面和快速切换功能：

```cpp
void MainWindow::setupUI()
{
    m_tableView = new QTableView(this);
    m_tableView->setAlternatingRowColors(true);
    m_tableView->setSelectionBehavior(QAbstractItemView::SelectRows);
    m_tableView->setSelectionMode(QAbstractItemView::ExtendedSelection);
    m_tableView->setSortingEnabled(true);
    m_tableView->horizontalHeader()->setStretchLastSection(true);
    setCentralWidget(m_tableView);
}
```



## 3.3 查询统计模块



### 3.3.1 时间段统计

按时间段统计检测数量和合格数量：

```cpp
void StatisticsDialog::onStatByDate()
{
    m_resultTable->clear();
    m_resultTable->setColumnCount(3);
    m_resultTable->setHorizontalHeaderLabels({"日期", "检测数量", "合格数量"});
    
    QSqlQuery query(DatabaseHelper::instance()->getDatabase());
    query.prepare(
        "SELECT test_date, COUNT(*) as total, "
        "SUM(CASE WHEN EXISTS("
        "    SELECT 1 FROM test_result_items "
        "    WHERE test_record_id = test_records.id AND is_qualified = 0"
        ") THEN 0 ELSE 1 END) as qualified "
        "FROM test_records "
        "WHERE test_date BETWEEN ? AND ? "
        "GROUP BY test_date "
        "ORDER BY test_date");
        
    query.addBindValue(m_startDate->date().toString("yyyy-MM-dd"));
    query.addBindValue(m_endDate->date().toString("yyyy-MM-dd"));
    
    if (query.exec()) {
        m_resultTable->setRowCount(0);
        while (query.next()) {
            int row = m_resultTable->rowCount();
            m_resultTable->insertRow(row);
            m_resultTable->setItem(row, 0, 
                new QTableWidgetItem(query.value(0).toString()));
            m_resultTable->setItem(row, 1, 
                new QTableWidgetItem(query.value(1).toString()));
            m_resultTable->setItem(row, 2, 
                new QTableWidgetItem(query.value(2).toString()));
        }
    }
}
```

**查询特点：**
- 使用BETWEEN进行日期范围过滤
- 使用GROUP BY按日期分组
- 使用子查询EXISTS判断合格情况
- 使用CASE WHEN进行条件统计



### 3.3.2 厂商合格率统计

按厂商统计检测数量和合格率：

```cpp
void StatisticsDialog::onStatByManufacturer()
{
    QSqlQuery query(DatabaseHelper::instance()->getDatabase());
    query.prepare(
        "SELECT m.name, COUNT(tr.id) as total, "
        "SUM(CASE WHEN EXISTS("
        "    SELECT 1 FROM test_result_items "
        "    WHERE test_record_id = tr.id AND is_qualified = 0"
        ") THEN 0 ELSE 1 END) as qualified "
        "FROM manufacturers m "
        "LEFT JOIN equipment_info ei ON m.id = ei.manufacturer_id "
        "LEFT JOIN test_records tr ON ei.id = tr.equipment_id "
        "WHERE tr.test_date BETWEEN ? AND ? "
        "GROUP BY m.id, m.name "
        "HAVING COUNT(tr.id) > 0 "
        "ORDER BY qualified * 100.0 / COUNT(tr.id) DESC");
    
    // 执行查询并展示结果...
}
```

**查询特点：**
- 使用LEFT JOIN关联多张表
- 使用HAVING过滤无记录的厂商
- 按合格率降序排列



### 3.3.3 月度工作量统计

按月统计检测工作量：

```cpp
void StatisticsDialog::onStatByMonth()
{
    QSqlQuery query(DatabaseHelper::instance()->getDatabase());
    query.prepare(
        "SELECT strftime('%Y-%m', test_date) as month, "
        "COUNT(*) as total, "
        "SUM(CASE WHEN EXISTS("
        "    SELECT 1 FROM test_result_items "
        "    WHERE test_record_id = test_records.id AND is_qualified = 0"
        ") THEN 0 ELSE 1 END) as qualified "
        "FROM test_records "
        "WHERE test_date BETWEEN ? AND ? "
        "GROUP BY strftime('%Y-%m', test_date) "
        "ORDER BY month DESC");
    
    // 执行查询并展示结果...
}
```

**查询特点：**
- 使用strftime函数提取年月
- 按年月分组统计
- 按月份降序排列



## 3.4 报告生成模块



### 3.4.1 报告内容设计

检测报告包含以下内容：
1. 报告标题和日期
2. 设备基本信息
3. 检测条件
4. 检测结果项（PT1、PT2、CT1、CT2）
5. 详细测量数据（ao、bo、co点）
6. 检测结论和签字栏



### 3.4.2 PDF生成实现

**（1）HTML报告生成**

```cpp
QString ReportGenerator::generateReportHTML(int testRecordId)
{
    QSqlQuery query(DatabaseHelper::instance()->getDatabase());
    
    // 查询基本信息（联表查询）
    query.prepare(
        "SELECT ei.product_code, ei.product_name, ei.product_model, "
        "m.name, tr.test_date, tr.tester_name, tr.test_location "
        "FROM test_records tr "
        "JOIN equipment_info ei ON tr.equipment_id = ei.id "
        "LEFT JOIN manufacturers m ON ei.manufacturer_id = m.id "
        "WHERE tr.id = ?");
    query.addBindValue(testRecordId);
    
    if (!query.exec() || !query.next()) {
        return "<html><body><h1>错误：查询失败</h1></body></html>";
    }
    
    // 构建HTML内容
    QString html = R"(
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <style>
            body { font-family: SimSun; font-size: 12pt; }
            h1 { text-align: center; font-size: 18pt; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black; padding: 8px; }
        </style>
    </head>
    <body>
        <h1>互感器二次压降检测仪检定报告</h1>
        <!-- 报告内容 -->
    </body>
    </html>
    )";
    
    return html;
}
```

**（2）PDF导出**

```cpp
bool ReportGenerator::generateTestReport(int testRecordId, 
                                         const QString &outputPath)
{
    QString htmlContent = generateReportHTML(testRecordId);
    
    QTextDocument document;
    document.setHtml(htmlContent);
    
    QPrinter printer(QPrinter::HighResolution);
    printer.setOutputFormat(QPrinter::PdfFormat);
    printer.setOutputFileName(outputPath);
    printer.setPageSize(QPageSize(QPageSize::A4));
    printer.setPageMargins(QMarginsF(15, 15, 15, 15), 
                          QPageLayout::Millimeter);
    
    document.print(&printer);
    return true;
}
```



### 3.4.3 打印功能实现

```cpp
void MainWindow::onPrintReport()
{
    QModelIndexList selected = m_tableView->selectionModel()->selectedRows();
    if (selected.isEmpty()) {
        QMessageBox::warning(this, "提示", "请先选择要打印的检测记录");
        return;
    }
    
    int recordId = m_currentModel->data(
        m_currentModel->index(selected.first().row(), 0)).toInt();
    
    QPrinter printer(QPrinter::HighResolution);
    QPrintDialog printDialog(&printer, this);
    
    if (printDialog.exec() == QDialog::Accepted) {
        ReportGenerator generator;
        generator.printTestReport(recordId, &printer);
        QMessageBox::information(this, "成功", "打印完成");
    }
}
```

**功能特点：**
- 使用HTML模板生成报告
- 支持CSS样式定制
- 支持A4纸张和自定义页边距
- 支持高分辨率输出
- 不合格项红色加粗显示


<div style="page-break-after: always;"></div>





# 第4章 系统测试



## 4.1 测试环境

**硬件环境：**
- 处理器：Intel Core i5 或以上
- 内存：8GB RAM
- 硬盘：100GB 可用空间

**软件环境：**
- 操作系统：Windows 10 64位
- 开发工具：Qt Creator 13.0.1
- Qt版本：Qt 6.8.3
- 编译器：MinGW 11.2.0 64-bit
- 数据库：SQLite 3.x



## 4.2 功能测试



### 4.2.1 数据输入测试

**测试项1：手动添加厂商信息**

测试步骤：
1. 启动系统
2. 点击"厂商信息"标签
3. 点击"添加"按钮
4. 输入厂商名称"测试厂商"、联系人"张三"、电话"13800138000"
5. 点击"确定"

预期结果：弹出"添加成功"提示，表格中显示新增的厂商记录

测试结果：✓ 通过

**测试项2：CSV批量导入设备信息**

测试步骤：
1. 准备test_equipment.csv文件（包含10条设备记录）
2. 点击"设备信息"标签
3. 点击"导入CSV"按钮
4. 选择test_equipment.csv文件
5. 等待导入完成

预期结果：显示进度条，导入完成后提示"成功导入10条设备记录"

测试结果：✓ 通过

**测试项3：必填项验证**

测试步骤：
1. 点击"添加"按钮打开添加对话框
2. 不输入必填项，直接点击"确定"

预期结果：弹出警告提示"XX字段不能为空"

测试结果：✓ 通过



### 4.2.2 数据管理测试

**测试项4：数据查询展示**

测试步骤：
1. 依次点击"厂商信息"、"设备信息"、"检测记录"、"检测结果项"按钮
2. 观察表格数据显示

预期结果：每个标签页正确显示对应表的数据，中文表头正确显示

测试结果：✓ 通过

**测试项5：数据删除**

测试步骤：
1. 在检测记录表中选中一条记录
2. 点击"删除"按钮
3. 确认删除

预期结果：记录被删除，相关的检测结果项也被级联删除

测试结果：✓ 通过

**测试项6：数据刷新**

测试步骤：
1. 在另一个程序中修改数据库
2. 点击"刷新"按钮

预期结果：表格数据更新为最新状态

测试结果：✓ 通过



### 4.2.3 查询统计测试

**测试项7：时间段统计**

测试步骤：
1. 点击"统计分析"按钮
2. 设置开始日期为"2024-01-01"，结束日期为"2024-12-31"
3. 选择"按时间段统计"
4. 点击"查询"

预期结果：显示该时间段内每天的检测数量和合格数量

测试结果：✓ 通过

**测试项8：厂商合格率统计**

测试步骤：
1. 打开统计对话框
2. 选择"按厂商统计合格率"
3. 点击"查询"

预期结果：显示各厂商的检测数量、合格数量和合格率，按合格率降序排列

测试结果：✓ 通过

**测试项9：月度工作量统计**

测试步骤：
1. 打开统计对话框
2. 选择"按月统计工作量"
3. 设置日期范围
4. 点击"查询"

预期结果：显示每月的检测数量统计

测试结果：✓ 通过



### 4.2.4 报告生成测试

**测试项10：PDF报告生成**

测试步骤：
1. 在检测记录表中选中一条记录
2. 点击"生成报告"按钮
3. 选择保存位置
4. 保存PDF文件

预期结果：生成PDF文件，包含完整的设备信息、检测条件、检测结果

测试结果：✓ 通过

**测试项11：报告打印**

测试步骤：
1. 选中一条检测记录
2. 点击菜单"文件"->"打印报告"
3. 在打印对话框中选择打印机
4. 点击"打印"

预期结果：报告正确输出到打印机

测试结果：✓ 通过



## 4.3 界面展示

系统主要界面如下：

**图4-1 主窗口界面**

主窗口包含菜单栏、工具栏和数据表格视图。工具栏提供了快速切换不同数据表的按钮，以及常用功能按钮。表格采用交替行颜色设计，提高可读性。

**图4-2 添加数据对话框**

添加对话框采用表单布局，必填项用*号标识。关联字段使用下拉选择框，日期字段使用日历选择器。界面简洁友好，操作便捷。

**图4-3 统计分析对话框**

统计对话框顶部提供查询条件设置区域，包括日期范围选择和统计类型选择。下方表格展示统计结果，支持排序功能。

**图4-4 PDF检测报告**

PDF报告采用标准的检定报告格式，包含报告标题、设备信息表、检测条件表、检测结果表和签字栏。布局规范，信息完整。



## 4.4 测试结果分析

**测试统计：**
- 测试项总数：11项
- 通过项数：11项
- 通过率：100%

**测试结论：**

系统各项功能均达到设计要求，测试结果良好。具体表现为：

（1）数据输入功能完善，支持手动添加和批量导入两种方式，数据验证机制有效，防止错误数据录入。

（2）数据管理功能完整，增删改查操作流畅，支持多表切换，界面友好。

（3）查询统计功能强大，支持多维度统计分析，SQL查询性能良好，结果准确。

（4）报告生成功能实用，PDF报告格式规范，打印功能正常。

（5）系统运行稳定，未发现明显bug，用户体验良好。

**存在的不足：**

（1）界面美观度还有提升空间，可以考虑使用QSS样式表美化界面。

（2）统计结果缺少图表展示，建议引入QChart模块增加可视化功能。

（3）缺少数据备份和恢复功能，建议增加数据库备份功能。


<div style="page-break-after: always;"></div>





# 第5章 总结



## 5.1 项目完成情况

本项目成功开发了一套功能完善的二次压降检测仪信息管理系统，完成了课程设计的全部要求：

**（1）数据输入管理模块**
- ✓ 实现了手动输入功能，支持厂商、设备、检测记录、检测结果的添加
- ✓ 实现了CSV批量导入功能，支持大量历史数据的快速录入
- ✓ 提供了完善的数据验证机制

**（2）数据管理模块**
- ✓ 建立了完整的SQLite数据库，包含5张关联表
- ✓ 实现了完整的CRUD操作
- ✓ 支持数据的查询、修改、删除
- ✓ 设置了外键约束和级联删除

**（3）查询统计模块**
- ✓ 实现了按时间段统计检测数量
- ✓ 实现了按厂商统计合格率
- ✓ 实现了按月统计工作量
- ✓ 支持联表查询和复杂SQL统计

**（4）报告生成模块**
- ✓ 实现了检测报告的自动生成
- ✓ 支持PDF格式导出
- ✓ 支持报告打印功能
- ✓ 报告内容完整、格式规范

系统完成度达到100%，所有核心功能均已实现并通过测试。



## 5.2 技术亮点

**（1）设计模式的应用**

采用单例模式设计DatabaseHelper类，确保全局只有一个数据库连接实例，避免资源浪费和并发问题。

**（2）三层架构设计**

系统采用表示层、业务逻辑层、数据访问层的三层架构，实现了界面与业务逻辑的分离，提高了系统的可维护性和可扩展性。

**（3）SQL优化**

在统计查询中使用了子查询、联表查询、分组统计等高级SQL技术，提高了查询效率。使用参数化查询防止SQL注入攻击。

**（4）外键约束与级联删除**

数据库设计中使用了外键约束保证数据完整性，使用ON DELETE CASCADE实现级联删除，简化了数据管理逻辑。

**（5）CSV智能解析**

实现了健壮的CSV解析算法，能够正确处理包含逗号、引号等特殊字符的字段，提高了批量导入的可靠性。

**（6）HTML模板报告生成**

使用HTML模板生成报告，通过CSS控制样式，实现了灵活的报告定制，便于后期维护和修改。

**（7）Qt Model/View架构**

充分利用Qt的Model/View架构，使用QSqlTableModel和QTableView实现数据的自动绑定和显示，减少了代码量。



## 5.3 存在的问题

**（1）界面美观度有待提升**

当前界面采用Qt默认样式，虽然功能完善，但视觉效果一般。可以考虑使用QSS（Qt Style Sheets）对界面进行美化，提升用户体验。

**（2）缺少数据可视化功能**

统计结果仅以表格形式展示，缺少直观的图表展示。建议引入Qt Charts模块，添加柱状图、折线图、饼图等可视化组件。

**（3）缺少数据备份功能**

系统缺少数据库备份和恢复功能，存在数据丢失风险。建议增加自动备份和手动备份功能。

**（4）详细数据编辑功能不完善**

虽然实现了DetailDataDialog用于查看详细测量数据，但编辑功能还不够完善，用户体验有待优化。

**（5）缺少用户权限管理**

系统没有实现用户登录和权限管理功能，所有用户具有相同权限。对于实际应用，应该增加用户认证和权限控制。

**（6）缺少数据导出功能**

除了PDF报告导出外，缺少将统计结果导出为Excel等格式的功能，不利于数据的二次分析。



## 5.4 改进方向

**（1）界面优化**
- 使用QSS美化界面，采用现代化的扁平化设计
- 增加主题切换功能（浅色/深色主题）
- 优化布局，提高空间利用率

**（2）功能扩展**
- 引入Qt Charts实现数据可视化
- 添加数据导出为Excel功能
- 实现用户登录和权限管理
- 增加数据库自动备份功能
- 添加操作日志记录功能

**（3）性能优化**
- 对大数据量查询进行优化
- 添加数据分页功能
- 实现数据缓存机制

**（4）用户体验提升**
- 添加快捷键支持
- 实现撤销/重做功能
- 添加数据批量编辑功能
- 提供更详细的操作提示



## 5.5 个人体会

通过本次课程设计，我对软件工程的完整开发流程有了更深入的理解和实践。以下是我的主要体会：

**（1）需求分析的重要性**

在项目初期，花时间进行详细的需求分析和系统设计是非常必要的。良好的需求分析可以避免后期频繁返工，提高开发效率。

**（2）设计模式的价值**

单例模式、MVC模式等设计模式的应用，使代码结构更加清晰，提高了代码的可维护性和可扩展性。在实际开发中应该重视设计模式的学习和应用。

**（3）数据库设计的关键性**

合理的数据库设计是系统成功的基础。通过本次实践，我深刻体会到外键约束、索引优化、SQL查询优化等技术的重要性。

**（4）Qt框架的强大**

Qt框架提供了丰富的组件和工具，极大地简化了GUI应用程序的开发。特别是Qt SQL模块和Model/View架构，使数据库应用的开发变得非常高效。

**（5）测试的必要性**

系统的测试工作不容忽视。通过系统的功能测试，发现并修复了多个潜在问题，保证了系统的稳定性和可靠性。

**（6）文档的重要性**

良好的代码注释和项目文档对于项目的维护和交接至关重要。在实际工作中应该养成编写文档的良好习惯。

**（7）持续学习的必要性**

软件技术日新月异，需要保持持续学习的态度。在开发过程中遇到的问题，通过查阅文档、搜索资料、学习新技术得到了解决。

总之，本次课程设计是一次全面而深入的软件工程实践，不仅巩固了理论知识，更重要的是培养了独立分析问题、解决问题的能力，为今后的学习和工作打下了坚实的基础。


<div style="page-break-after: always;"></div>





# 参考文献

[1] The Qt Company. Qt Documentation[EB/OL]. https://doc.qt.io/, 2024

[2] SQLite. SQLite Documentation[EB/OL]. https://www.sqlite.org/docs.html, 2024

[3] 萨师煊, 王珊. 数据库系统概论（第五版）[M]. 高等教育出版社, 2014

[4] 张海藩, 牟永敏. 软件工程导论（第六版）[M]. 清华大学出版社, 2013

[5] 谭浩强. C++程序设计（第三版）[M]. 清华大学出版社, 2015

**说明：** 本系统基于Qt 6.8.3框架开发，主要参考了Qt官方文档和SQLite官方文档，以及相关经典教材

---

**报告编写完成日期：** 2026年1月3日  
**系统版本：** v1.0  
**开发工具：** Qt Creator 13.0.1 + Qt 6.8.3  
**数据库：** SQLite 3.x

---

**说明：** 
1. 本报告完整记录了二次压降检测仪信息管理系统的设计、开发、测试全过程
2. 系统源代码、数据库文件、测试数据均已完成
3. 所有功能均已实现并通过测试
4. 系统可直接运行使用

